<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');
class Customers extends CI_Model
{	
	public $data;
	public $id_cliente;
	public $email;
	public $status;
	public $datos_sess;
	function __construct()
	{	
		parent::__construct();
		$this->datos_sess = $this->session->userdata('logged_in');
		$this->data = array();
		$this->id_cliente = '';
		$this->email = '';
		$this->status  = 'A';
	}
	public function crear(){
		
		$this->data = array(
				'RFC' => strtoupper($this->input->post('txt_rfc')),     'R_SOCIAL' => strtoupper($this->input->post('txt_razon')),     
				'NUM_EXT'   => $this->input->post('txt_num_ext'),
				'NOMBRE' => strtoupper($this->input->post('txt_nombre')),     'NUM_INT'   => $this->input->post('txt_num_int'),
				'APEPAT' => strtoupper($this->input->post('txt_apepat')),     'CRUCE_1'    => strtoupper($this->input->post('txt_cruce_uno')),
				'APEMAT' => strtoupper($this->input->post('txt_apemat')),     'CRUCE_2'    => strtoupper($this->input->post('txt_cruce_dos')),
				'TELEFONO_1' => $this->input->post('txt_telefono_uno'),        'FECHA_NAC' => $this->input->post('txt_fecha_nac'),           
				'TELEFONO_2' => $this->input->post('txt_telefono_dos'),        'DOMICILIO' => strtoupper($this->input->post('txt_domicilio')),        
				'CODIGO_P'      => $this->input->post('txt_cp'),              'COLONIA' => strtoupper($this->input->post('txt_colonia')),   
				'EMAIL' => $this->input->post('txt_email')
 			);
		$params_usuario = array('RFC'=>$this->data['RFC']);
		$this->db->select('RFC');
		$validar_usuario = $this->db->get_where('tbl_cliente',$params_usuario);
		if($validar_usuario->num_rows() === 1){
			return array('status'=>FALSE,'msg'=>"El RFC <b>".$this->data['RFC']."</b> Ya esta Registrado.");
		}
		$params_email = array('EMAIL'=>$this->data['EMAIL']);
		$this->db->select('EMAIL');
		$validar_mail = $this->db->get_where('tbl_cliente',$params_email);
		if($validar_mail->num_rows() === 1){
			return array('status'=>FALSE,'mensaje'=>"El correo electronico <b>".$this->data['EMAIL']."</b> Ya existe.");
		}
	
		$this->db->trans_begin();
		$this->db->insert('tbl_cliente',$this->data);
		if($this->db->trans_status() === TRUE){
			
			if($this->db->affected_rows() === 1){
			$this->db->trans_commit();
			return array('status'=>TRUE,'msg'=>'El cliente  '. $this->data['R_SOCIAL'].' ha sido agregado correctamente.');
		}
		}
		else{
			$this->db->trans_rollback();
			return array('status'=>FALSE,'msg'=>"Ha ocurrido un error inesperado intentelo mas tarde.");	
		}

	}
	public function catalogo_cliente(){
		$this->db->select('RFC,R_SOCIAL,NOMBRE,APEPAT,APEMAT,TELEFONO_1');
		$this->db->from('tbL_cliente');
		$queryC = $this->db->get();
		if($queryC->num_rows()>0){
			return $queryC->result_array();
		}
		return FALSE;
	}
	public function get_cliente(){
		$param = array('RFC'=>strtoupper($this->input->post('cliente')));
		$this->db->select('RFC as txt_rfc,NOMBRE as txt_nombre,R_SOCIAL as txt_razon,APEPAT as txt_apepat,APEMAT as txt_apemat,FECHA_NAC as txt_fecha_nac,'.
						'DOMICILIO as txt_domicilio,NUM_EXT as txt_num_ext,NUM_INT as txt_num_int,COLONIA as txt_colonia,'.
						'CRUCE_1 as txt_cruce_uno,CRUCE_2 as txt_cruce_dos,CODIGO_P as txt_cp,TELEFONO_1 as txt_telefono_uno,TELEFONO_2 as txt_telefono_dos,'.
						'EMAIL as txt_email');
		$query = $this->db->get_where('tbl_cliente',$param);
		if($query->num_rows > 0){
			return $query->row();
		}
		else{
			return FALSE;
		}
	}
	public function update_cliente(){
		
		$this->id_cliente =  $this->session->userdata('rfc_cliente');
		$this->email =  $this->session->userdata('email_cliente');
		$this->data = array(
				'RFC' => strtoupper($this->input->post('txt_rfc')),     'R_SOCIAL' => strtoupper($this->input->post('txt_razon')),     
				'NUM_EXT'   => $this->input->post('txt_num_ext'),
				'NOMBRE' => strtoupper($this->input->post('txt_nombre')),     'NUM_INT'   => $this->input->post('txt_num_int'),
				'APEPAT' => strtoupper($this->input->post('txt_apepat')),     'CRUCE_1'    => strtoupper($this->input->post('txt_cruce_uno')),
				'APEMAT' => strtoupper($this->input->post('txt_apemat')),     'CRUCE_2'    => strtoupper($this->input->post('txt_cruce_dos')),
				'TELEFONO_1' => $this->input->post('txt_telefono_uno'),        'FECHA_NAC' => $this->input->post('txt_fecha_nac'),           
				'TELEFONO_2' => $this->input->post('txt_telefono_dos'),        'DOMICILIO' => strtoupper($this->input->post('txt_domicilio')),        
				'CODIGO_P'      => $this->input->post('txt_cp'),              'COLONIA' => strtoupper($this->input->post('txt_colonia')),   
				'EMAIL' => $this->input->post('txt_email')
 			);
		if($this->data['RFC'] !== $this->id_cliente){
				$param_cliente = array('RFC'=>$this->data['RFC']);
				$this->db->select('RFC');
				$validar_cliente = $this->db->get_where('tbl_cliente',$param_cliente);
				if($validar_cliente->num_rows() === 1){
					return array('status'=>FALSE,'msg'=>"<div class='alert alert-danger'>El RFC <b>".$this->data['RFC']."</b> Ya esta Registrado.</div>");
				}
		}
		if($this->data['EMAIL'] !== $this->email){
			$params_email = array('EMAIL'=>$this->data['EMAIL']);
			$this->db->select('EMAIL');
			$validar_mail = $this->db->get_where('tbl_cliente',$params_email);
			if($validar_mail->num_rows() === 1){
				return array('status'=>FALSE,'msg'=>"<div class='alert alert-danger'>El correo electronico <b>".$this->data['EMAIL']."</b> Ya existe.</div>");
			}
		}
		

		$param_cliente = array('RFC'=>$this->id_cliente);
		$this->db->trans_begin();
		$this->db->update('tbl_cliente',$this->data,$param_cliente);
		if($this->db->trans_status() === TRUE){
			
			$this->db->trans_commit();
			return array('status'=>TRUE,'msg'=>'<div class="alert alert-success">La informaci√≥n del cliente <b>'. $this->data['R_SOCIAL'].'</b> ha sido actualizada.</div>');
		
		}
		else{
			$this->db->trans_rollback();
			return array('status'=>FALSE,'msg'=>"<div class='alert alert-danger'>Ha ocurrido un error inesperado intentelo mas tarde.</div>");	
		}
	}
	
}