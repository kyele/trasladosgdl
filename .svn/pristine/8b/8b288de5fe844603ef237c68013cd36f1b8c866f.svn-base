<?php  if ( ! defined('BASEPATH')) exit('No direct script access allowed');
class Rides extends CI_Model
{	
	public $data;
	public $datos_sess;
	function __construct()
	{	
		parent::__construct();
		$this->datos_sess = $this->session->userdata('logged_in');
		$this->data = array();
		
	}
	public function catalogos(){
		$this->db->select("RFC,R_SOCIAL as txt_razon,CONCAT(NOMBRE ,' ', APEPAT) as txt_nombre,DOMICILIO as txt_domicilio, NUM_EXT as txt_num_ext, CRUCE_1  as txt_cruce_uno,CRUCE_2 as txt_cruce_dos, COLONIA as txt_colonia",FALSE);
		$this->db->from('tbL_cliente');
		$queryC = $this->db->get();
		if($queryC->num_rows()>0){
			$this->data['clientes'] = $queryC->result_array();
		}else{
			$this->data['msg'] = '<div class="alert alert-danger">No se encontraron Clientes, Registre uno <a href="'.base_url().'nuevo_cliente.html">Aquí</a> </div>';
			return array('status'=>false,'msg'=>$this->data['msg']);
		}

		$this->db->select('IDCHOFER,NOMBRE,APEPAT');
        $this->db->from('tbl_chofer');
        $this->db->where('SITUACION <> "B" AND DISPONIBILIDAD = 1 ');
        $queryCh = $this->db->get();
        if($queryCh->num_rows()>0){
        	$this->data['choferes'] = $queryCh->result_array();
        }else{
        	$this->data = array();
        	$this->data['msg'] = '<div class="alert alert-danger">No se encontraron Choferes Disponible, Registre uno <a href="'.base_url().'nuevo_chofer.html">Aquí</a> o actualize la disponiblidad</div>';
			return array('status'=>false,'msg'=>$this->data['msg']);
        }

        $this->db->select('tbl_vehiculos.IDVEHICULO,tbl_vehiculos.COLOR, tbl_modelo.MODELO');
        $this->db->from('tbl_vehiculos , tbl_modelo ');
		$this->db->where('tbl_vehiculos.DISPONIBILIDAD <> "B" AND tbl_vehiculos.DISPONIBILIDAD = 1 AND tbl_vehiculos.IDMODELO = tbl_modelo.IDMODELO ');
        
        $queryCh = $this->db->get();
        if($queryCh->num_rows()>0){
        	$this->data['vehiculos'] = $queryCh->result_array();
        }else{
        	$this->data = array();
        	$this->data['msg'] = '<div class="alert alert-danger">No se encontraron Vehiculos Disponibles, Registre uno <a href="'.base_url().'nuevo_vehiculo.html">Aquí</a> o actualize la disponiblidad</div>';
			return array('status'=>false,'msg'=>$this->data['msg']);
        }


        return array('info'=>$this->data,'status'=>true);

		
	}
	public function crear(){
		
		$this->data = array(
				'IDCLIENTE' => strtoupper($this->input->post('txt_cliente')),     'LUGAR_REF' => strtoupper($this->input->post('txt_referencial')),     
				'DOMICILIO'   => $this->input->post('txt_domicilio'),'NUM_EXT'=>$this->input->post('txt_num_ext'),
				'COLONIA' => strtoupper($this->input->post('txt_colonia')),'CRUCE1'=>strtoupper($this->input->post('txt_cruce_uno')),
				'CRUCE2'=>strtoupper($this->input->post('txt_cruce_dos')),'NOMBRE_PASAJERO'=>strtoupper($this->input->post('txt_nombre')),
				'NUM_PASAJEROS'=>($this->input->post('txt_num_pasajeros')),'NOMBRE_SOLICITANTE'=>($this->input->post('txt_nombre_sol')),
				'FECHA'=>$this->input->post('txt_traslado'),'HORA'=>$this->input->post('txt_hora'),'FORMATO_PAGO'=>$this->input->post('txt_forma_pago'),
				'IDCHOFER'=>$this->input->post('txt_conductor'),'IDCOMPROBANTE'=>'ASD','IDVEHICULO'=>$this->input->post('txt_vehiculo'),
				'MONTO'=>$this->input->post('txt_monto'),'OBSERVACIONES'=>$this->input->post('txt_observaciones')
 			);

		//validamos que el chofer no tenga traslados en su agenda
		$params_chofer = array('IDCHOFER'=>$this->data['IDCHOFER']);
		$this->db->select('HORA');
		$this->db->from('tbl_traslados');
		$array = array('IDCHOFER'=>$this->data['IDCHOFER'],'FECHA'=>$this->data['FECHA'],'ESTATUS'=>'EC');
		$this->db->where($array);
		$validar_chofer = $this->db->get();
		$hora_validate = explode(':', $this->data['HORA']);
		$char_agenda = '';
		if($validar_chofer->num_rows() === 1){

			foreach ($validar_chofer->result_array() as $chofer_agenda) {

				$hora_tmp = explode(':', $chofer_agenda['HORA']);
				
				if(( (int)$hora_validate[0] <= (int)$hora_tmp[0]  ) || (  (   (int)$hora_validate[0] - (int)$hora_tmp[0]  )  < 2 ) ){
					$char_agenda.= 'FECHA : '.$this->data['FECHA'].'  - HORA: '.$chofer_agenda['HORA']."<br>";
				}
				
			}
			if(trim($char_agenda) !== ''){
				return array('status'=>FALSE,'msg'=>"El chofer seleccionado tiene pendientes los siguientes traslados: <br><b>".$char_agenda."</b>");
			}
			
		}
		return array('status'=>TRUE,'msg'=>"EXITO");

		//validamos que el vehiculo elegido este disponible

		// $params_email = array('EMAIL'=>$this->data['EMAIL']);
		// $this->db->select('EMAIL');
		// $validar_mail = $this->db->get_where('tbl_cliente',$params_email);
		// if($validar_mail->num_rows() === 1){
		// 	return array('status'=>FALSE,'mensaje'=>"El correo electronico <b>".$this->data['EMAIL']."</b> Ya existe.");
		// }


		// //GUARDAMOS EL TRASLADO
		// $this->db->trans_begin();
		// $this->db->insert('tbl_cliente',$this->data);
		// if($this->db->trans_status() === TRUE){
			
		// 	if($this->db->affected_rows() === 1){
		// 	$this->db->trans_commit();
		// 	return array('status'=>TRUE,'msg'=>'El cliente  '. $this->data['R_SOCIAL'].' ha sido agregado correctamente.');
		// }
		// }
		// else{
		// 	$this->db->trans_rollback();
		// 	return array('status'=>FALSE,'msg'=>"Ha ocurrido un error inesperado intentelo mas tarde.");	
		// }

	}
	
	public function get_cliente(){
		$param = array('RFC'=>strtoupper($this->input->post('cliente')));
		$this->db->select('RFC as txt_rfc,NOMBRE as txt_nombre,R_SOCIAL as txt_razon,APEPAT as txt_apepat,APEMAT as txt_apemat,FECHA_NAC as txt_fecha_nac,'.
						'DOMICILIO as txt_domicilio,NUM_EXT as txt_num_ext,NUM_INT as txt_num_int,COLONIA as txt_colonia,'.
						'CRUCE_1 as txt_cruce_uno,CRUCE_2 as txt_cruce_dos,CODIGO_P as txt_cp,TELEFONO_1 as txt_telefono_uno,TELEFONO_2 as txt_telefono_dos,'.
						'EMAIL as txt_email');
		$query = $this->db->get_where('tbl_cliente',$param);
		if($query->num_rows > 0){
			return $query->row();
		}
		else{
			return FALSE;
		}
	}
	public function update_cliente(){
		
		$this->id_cliente =  $this->session->userdata('rfc_cliente');
		$this->email =  $this->session->userdata('email_cliente');
		$this->data = array(
				'RFC' => strtoupper($this->input->post('txt_rfc')),     'R_SOCIAL' => strtoupper($this->input->post('txt_razon')),     
				'NUM_EXT'   => $this->input->post('txt_num_ext'),
				'NOMBRE' => strtoupper($this->input->post('txt_nombre')),     'NUM_INT'   => $this->input->post('txt_num_int'),
				'APEPAT' => strtoupper($this->input->post('txt_apepat')),     'CRUCE_1'    => strtoupper($this->input->post('txt_cruce_uno')),
				'APEMAT' => strtoupper($this->input->post('txt_apemat')),     'CRUCE_2'    => strtoupper($this->input->post('txt_cruce_dos')),
				'TELEFONO_1' => $this->input->post('txt_telefono_uno'),        'FECHA_NAC' => $this->input->post('txt_fecha_nac'),           
				'TELEFONO_2' => $this->input->post('txt_telefono_dos'),        'DOMICILIO' => strtoupper($this->input->post('txt_domicilio')),        
				'CODIGO_P'      => $this->input->post('txt_cp'),              'COLONIA' => strtoupper($this->input->post('txt_colonia')),   
				'EMAIL' => $this->input->post('txt_email')
 			);
		if($this->data['RFC'] !== $this->id_cliente){
				$param_cliente = array('RFC'=>$this->data['RFC']);
				$this->db->select('RFC');
				$validar_cliente = $this->db->get_where('tbl_cliente',$param_cliente);
				if($validar_cliente->num_rows() === 1){
					return array('status'=>FALSE,'msg'=>"<div class='alert alert-danger'>El RFC <b>".$this->data['RFC']."</b> Ya esta Registrado.</div>");
				}
		}
		if($this->data['EMAIL'] !== $this->email){
			$params_email = array('EMAIL'=>$this->data['EMAIL']);
			$this->db->select('EMAIL');
			$validar_mail = $this->db->get_where('tbl_cliente',$params_email);
			if($validar_mail->num_rows() === 1){
				return array('status'=>FALSE,'msg'=>"<div class='alert alert-danger'>El correo electronico <b>".$this->data['EMAIL']."</b> Ya existe.</div>");
			}
		}
		

		$param_cliente = array('RFC'=>$this->id_cliente);
		$this->db->trans_begin();
		$this->db->update('tbl_cliente',$this->data,$param_cliente);
		if($this->db->trans_status() === TRUE){
			
			$this->db->trans_commit();
			return array('status'=>TRUE,'msg'=>'<div class="alert alert-success">La información del cliente <b>'. $this->data['R_SOCIAL'].'</b> ha sido actualizada.</div>');
		
		}
		else{
			$this->db->trans_rollback();
			return array('status'=>FALSE,'msg'=>"<div class='alert alert-danger'>Ha ocurrido un error inesperado intentelo mas tarde.</div>");	
		}
	}
	
}