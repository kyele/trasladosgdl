<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');
session_start();
class Usuarios extends CI_Controller
{	
	public $char_error_open;
	public $char_error_close;
	public $session_data;
	public $tab_active;
        public $success;
        public $error_msg;
        public $name_img;
	function __construct()
	{	
		parent::__construct();
		$this->load->model('users','',TRUE);
		$this->char_error_open = '<span class="btn btn-danger btn-xs" style="margin:3px;"> <button type="button" class="close" data-dismiss="alert" aria-hidden="true"> &nbsp;×</button>';
		$this->char_error_close = '</span>';
		$this->tab_active = '#informacion_basica';
                $this->success = '';
                $this->error_msg = '';
                $this->name_img = '';
		if($this->session->userdata('logged_in'))
		{	
			$this->session_data = $this->session->userdata('logged_in');
		}
		else
		{
			redirect('login','refresh');
		}

	}
	public function nuevo(){
		
			$data['nombre'] = $this->session_data['nombre'];
			$data['apellido'] = $this->session_data['apellido'];
			$data['usuario_i'] = $this->session_data['usuario_i'];
                        $data['titulo'] = 'Agregar Usuario';
			$data['content']  = 'nuevo_usuario';
			$this->load->view('main_template',$data);
			
		
	}
        function file_check($file){
           if($_FILES['userfile']['type'] !== 'image/jpeg'){
                        $this->form_validation->set_message('file_check','La extension del %s seleccionado no está permitida (solo JPG)');
                        return FALSE;
                    }
            if($_FILES['userfile']['size'] > 200000){
                $this->form_validation->set_message('file_check','El  %s excede el limite permitido de peso ( hasta 2MB )');
                return FALSE;
                    }
        }
	public function crear(){
		
		$this->form_validation->set_error_delimiters($this->char_error_open,$this->char_error_close);
		$this->form_validation->set_rules('txt_rfc', 'RFC', 'required|trim|xss_clean|min_length[10]|max_length[10]');
		$this->form_validation->set_rules('txt_nombre','Nombre', 'required|trim|xss_clean');
		$this->form_validation->set_rules('txt_apepat','Apellido Paterno', 'required|trim|xss_clean');
		$this->form_validation->set_rules('txt_apemat','Apellido Materno', 'required|trim|xss_clean|xss_clean');
		$this->form_validation->set_rules('txt_email','Correo Electronico', 'required|valid_email|trim|xss_clean');	
		$this->form_validation->set_rules('txt_role','Permiso', 'required|trim|xss_clean');
                
	    if( empty($_FILES['userfile']['name'])){
	        $this->form_validation->set_rules('userfile','Archivo de imagen', 'required|xss_clean');
	    }else{
	        $this->form_validation->set_rules('userfile','Archivo de imagen', 'xss_clean|callback_file_check');
	    }
            
        $this->form_validation->set_message('required', 'El  %s es requerido');
       	$this->form_validation->set_message('valid_email', 'El %s no es válido');


		if ($this->form_validation->run() === FALSE)
		{ 
			$data = array('errors'=>validation_errors(),'statusError'=>TRUE);
			echo json_encode($data);
		}
		else
		{		
			$datos = array(
				'rfc'=>  strtoupper($this->input->post('txt_rfc')),
				'nombre'=>strtoupper($this->input->post('txt_nombre')),
				'apepat'=>strtoupper($this->input->post('txt_apepat')),
				'apemat'=>strtoupper($this->input->post('txt_apemat')),
				'email'=>$this->input->post('txt_email'),
				'role'=>$this->input->post('txt_role')
				);
			$result  = $this->users->nuevo($datos);
			if(! $result['status'])
			{
				$data = array('errors'=>$this->char_error_open.$result['mensaje'].$this->char_error_close,'statusError'=>TRUE);
				echo json_encode($data);
			}
			else
			{
				$upload = $this->upload();
				if( ! $upload["status"])
				{
					$data = array('errors'=>$upload['errorUpload'],'statusError'=>TRUE);
					echo json_encode($data);
				}
				else
				{
					$data = array('statusError'=>FALSE,'usuario'=>$result['mensaje']);
					echo json_encode($data);
				}
			}
		}
	}
	public function upload(){
                
                if(($this->input->post('txt_rfc'))){
                    $this->name_img = $this->input->post('txt_rfc');
                }
                else{
                    $this->name_img = $this->session_data['usuario_i'];
                }
		$nombre_campo = "userfile";
		$opt['upload_path'] = './img/profiles/';
		$opt['allowed_types'] = 'jpg';
		$opt['max_size'] = '2048'; 
		$opt['max_width'] = '340';
		$opt['max_height'] = '340';
		$opt['file_name'] = strtoupper($this->name_img);
		$opt['overwrite']  = TRUE;
		$this->load->library('upload',$opt);
		if( ! $this->upload->do_upload($nombre_campo))
		{
			return array(
				"errorUpload"=> $this->upload->display_errors($this->char_error_open, $this->char_error_close),
				'status'=>FALSE);
		}
		else{
			return array('status'=>TRUE);
		}

	}
	public function profile(){
		
			
				$data['nombre'] = $this->session_data['nombre'];
				$data['apellido'] = $this->session_data['apellido'];
				$data['usuario_i'] = $this->session_data['usuario_i'];
				$data['apemat']  = $this->session_data['apellido_m'];
				$data['email']  = $this->session_data['email'];
				$data['titulo'] = 'Perfil de Usuario';
				$data['content']  = 'mi_perfil';
                                $data['success'] = $this->success;
                                $data['error'] = $this->error_msg;
				$data['tab'] = $this->tab_active;
				$this->load->view('main_template',$data);
			
	}
        
	public function update_profile($param){		
		$this->form_validation->set_error_delimiters($this->char_error_open,$this->char_error_close);
		if($param === 'info')
		{
			$this->form_validation->set_rules('txt_nombre','Nombre', 'required|trim|xss_clean');
			$this->form_validation->set_rules('txt_apepat', 'Apellido Paterno', 'required|trim|xss_clean');
			$this->form_validation->set_rules('txt_apemat','Apellido Materno', 'required|trim|xss_clean');
			$this->form_validation->set_rules('txt_mail','Correo Electronico', 'required|valid_email|trim|xss_clean');
			$this->form_validation->set_message('required', 'El  %s es requerido');
   			$this->form_validation->set_message('valid_email', 'El %s no es válido');
   			$this->tab_active = '#informacion_basica';
                        
		}
		else if($param === 'imagen'){
                    
                  $upload = $this->upload();
                   if( ! $upload["status"])
				{
                                    $this->error_msg = $upload['errorUpload'];
                                    
                                }
				else
				{
					$this->success = '<div class="alert alert-success">La imagen de perfil ha sido actualizada</div>';
				}
                    $this->tab_active = '#imagen_perfil';
	    	
		}
		else if($param === 'password'){
                    	$this->form_validation->set_rules('txt_current_pass', 'Contraseña Actual','trim|required');
			$this->form_validation->set_rules('txt_new_pass', 'Contraseña Nueva','trim|required|matches[txt_retype_new_pass]|min_length[6]');
			$this->form_validation->set_rules('txt_retype_new_pass', 'Confirmar Contraseña','trim|required');
			$this->form_validation->set_message('required', 'La  %s es requerida');
   			$this->tab_active = '#cambiar_pass';
		}
		
			if($this->form_validation->run() === TRUE){
                              if($param !== 'imagen'){
                                $result =   $this->users->update_profile($param);
                                if($result['status'] === TRUE){
                                    if($param==='info'){
                                        $this->session->set_userdata('logged_in',array('usuario_i'=>$this->session_data['usuario_i'],'role'=>$this->session_data['role'],'nombre'=>$result['nombre'],'apellido'=>$result['apepat'],'apellido_m'=>$result['apemat'],'email'=>$result['email']));
                                        $this->session_data = $this->session->userdata('logged_in');
                                    }
                                    $this->success = '<div class="alert alert-success">'.$result['msg'].'</div>';
                                }
                                  else
                                {
                                  $this->error_msg = '<div class="alert alert-danger">'.$result['msg'].'</div>';
                                }
                            }
                        }
                        $this->profile();
	}
		
	
}